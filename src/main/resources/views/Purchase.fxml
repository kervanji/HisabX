<?xml version="1.0" encoding="UTF-8"?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.geometry.Insets?>
<?import javafx.collections.FXCollections?>

<VBox xmlns="http://javafx.com/javafx/17" xmlns:fx="http://javafx.com/fxml/1"
      fx:controller="com.hisabx.controller.PurchaseController"
      stylesheets="@../styles/main.css"
      spacing="15"
      style="-fx-background-color: linear-gradient(to bottom right, #0f1b2d, #1a2744); -fx-padding: 20; -fx-font-family: 'Geeza Pro', 'SF Arabic', 'Arial', 'Tahoma';">
    
    <!-- Header -->
    <HBox alignment="CENTER" spacing="20" style="-fx-background-color: linear-gradient(to left, #f59e0b, #d97706); -fx-padding: 15; -fx-background-radius: 12;">
        <Label text="المشتريات" style="-fx-font-size: 28px; -fx-font-weight: bold; -fx-text-fill: white;"/>
        <Region HBox.hgrow="ALWAYS"/>
        <Button fx:id="previousPurchasesBtn" text="المشتريات السابقة" onAction="#showPreviousPurchases"
                style="-fx-background-color: white; -fx-text-fill: #d97706; -fx-font-weight: bold; -fx-padding: 10 20; -fx-background-radius: 8;"/>
    </HBox>
    
    <HBox spacing="20" VBox.vgrow="ALWAYS">
        <!-- Left Panel - Supplier Balance Info -->
        <VBox spacing="10" VBox.vgrow="ALWAYS" style="-fx-background-color: linear-gradient(to bottom, #2b2b1b, #3a3a23); -fx-padding: 15; -fx-background-radius: 12; -fx-min-width: 220;">
            <Label text="الرصيد السابق" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-text-fill: #fef3c7;"/>
            <Label fx:id="previousBalanceLabel" text="0" style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: #fcd34d;"/>
            
            <Separator/>
            
            <Label text="الرصيد الحالي" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-text-fill: #fef3c7;"/>
            <Label fx:id="currentBalanceLabel" text="0 د.ع" style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: #fcd34d;"/>
            
            <Separator/>
            
            <Label text="إجمالي المواد" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-text-fill: #fef3c7;"/>
            <Label fx:id="itemsTotalLabel" text="0" style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: #34d399;"/>
        </VBox>
        
        <!-- Right Panel - Form -->
        <VBox spacing="15" HBox.hgrow="ALWAYS" VBox.vgrow="ALWAYS" style="-fx-background-color: #10233d; -fx-padding: 20; -fx-background-radius: 12; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.25), 14, 0, 0, 6);">

            <GridPane hgap="6" vgap="10" nodeOrientation="RIGHT_TO_LEFT" alignment="TOP_LEFT">
                <columnConstraints>
                    <ColumnConstraints percentWidth="12" halignment="LEFT"/>
                    <ColumnConstraints percentWidth="38" hgrow="ALWAYS"/>
                    <ColumnConstraints percentWidth="12" halignment="LEFT"/>
                    <ColumnConstraints percentWidth="38" hgrow="ALWAYS"/>
                </columnConstraints>
                <rowConstraints>
                    <RowConstraints valignment="CENTER" minHeight="45"/>
                    <RowConstraints valignment="CENTER" minHeight="45"/>
                    <RowConstraints valignment="CENTER" minHeight="45"/>
                    <RowConstraints valignment="CENTER" minHeight="45"/>
                </rowConstraints>

                <!-- Row 0: supplier and voucher number -->
                <Label text="المورد/الحساب" style="-fx-font-weight: bold; -fx-text-fill: #e8edf4;" GridPane.columnIndex="0" GridPane.rowIndex="0" GridPane.valignment="CENTER"/>
                <HBox spacing="8" alignment="CENTER_LEFT" GridPane.columnIndex="1" GridPane.rowIndex="0" GridPane.valignment="CENTER" GridPane.hgrow="ALWAYS">
                    <Button text="+" onAction="#addNewCustomer" styleClass="button-danger"/>
                    <ComboBox fx:id="customerCombo" prefWidth="240" maxWidth="Infinity" promptText="اختر المورد/الحساب" editable="true" HBox.hgrow="ALWAYS"/>
                </HBox>

                <Label text="رقم المستند" style="-fx-font-weight: bold; -fx-text-fill: #e8edf4;" GridPane.columnIndex="2" GridPane.rowIndex="0" GridPane.valignment="CENTER"/>
                <TextField fx:id="voucherNumberField" editable="false" prefWidth="160"
                           style="-fx-background-color: #1a2744; -fx-text-fill: #e8edf4; -fx-prompt-text-fill: #607d8b; -fx-padding: 10; -fx-background-radius: 8;"
                           GridPane.columnIndex="3" GridPane.rowIndex="0" GridPane.valignment="CENTER"/>

                <!-- Row 1: date -->
                <Label text="التاريخ" style="-fx-font-weight: bold; -fx-text-fill: #e8edf4;" GridPane.columnIndex="0" GridPane.rowIndex="1" GridPane.valignment="CENTER"/>
                <DatePicker fx:id="voucherDatePicker" prefWidth="180" GridPane.columnIndex="1" GridPane.rowIndex="1" GridPane.valignment="CENTER"/>

                <!-- Row 2: Description and discount -->
                <Label text="البيان" style="-fx-font-weight: bold; -fx-text-fill: #e8edf4;" GridPane.columnIndex="0" GridPane.rowIndex="2" GridPane.valignment="CENTER"/>
                <TextField fx:id="descriptionField" promptText="مشتريات من .."
                           style="-fx-padding: 10; -fx-background-radius: 8;"
                           GridPane.columnIndex="1" GridPane.rowIndex="2" GridPane.valignment="CENTER" GridPane.hgrow="ALWAYS" maxWidth="Infinity"/>

                <Label text="الخصم" style="-fx-font-weight: bold; -fx-text-fill: #e8edf4;" GridPane.columnIndex="2" GridPane.rowIndex="2" GridPane.valignment="CENTER"/>
                <HBox spacing="6" alignment="CENTER_LEFT" GridPane.columnIndex="3" GridPane.rowIndex="2" GridPane.valignment="CENTER" GridPane.hgrow="ALWAYS">
                    <TextField fx:id="discountPercentField" text="0" prefWidth="45"
                               style="-fx-padding: 10; -fx-background-radius: 8;"/>
                    <Label text="\%"/>
                    <TextField fx:id="discountAmountField" text="0" prefWidth="110"
                               style="-fx-padding: 10; -fx-background-radius: 8;"/>
                </HBox>

                <!-- Row 3: Notes -->
                <Label text="ملاحظات" style="-fx-font-weight: bold; -fx-text-fill: #e8edf4;" GridPane.columnIndex="0" GridPane.rowIndex="3" GridPane.valignment="CENTER"/>
                <TextArea fx:id="notesArea" prefRowCount="1" promptText="ملاحظات"
                          style="-fx-padding: 8; -fx-background-radius: 8;"
                          GridPane.columnIndex="1" GridPane.rowIndex="3" GridPane.columnSpan="3" GridPane.valignment="CENTER" GridPane.hgrow="ALWAYS" maxWidth="Infinity"/>
            </GridPane>

            <!-- Items Table Section -->
            <VBox spacing="8" VBox.vgrow="ALWAYS" style="-fx-background-color: #0f1b2d; -fx-padding: 10; -fx-background-radius: 8;">
                <HBox spacing="10" alignment="CENTER_RIGHT" style="-fx-padding: 5;">
                    <Label text="المواد المشتراة" style="-fx-font-size: 16px; -fx-font-weight: bold; -fx-text-fill: #fcd34d;"/>
                    <Region HBox.hgrow="ALWAYS"/>
                    <Button text="+ إضافة مادة" onAction="#handleAddItem"
                            style="-fx-background-color: #f59e0b; -fx-text-fill: white; -fx-font-weight: bold; -fx-padding: 8 16; -fx-background-radius: 8; -fx-cursor: hand;"/>
                </HBox>
                
                <TableView fx:id="itemsTable" VBox.vgrow="ALWAYS" style="-fx-background-radius: 8;" editable="true">
                    <columns>
                        <TableColumn fx:id="itemProductColumn" text="المادة" prefWidth="200"/>
                        <TableColumn fx:id="itemQuantityColumn" text="الكمية" prefWidth="80"/>
                        <TableColumn fx:id="itemUnitColumn" text="الوحدة" prefWidth="80"/>
                        <TableColumn fx:id="itemPriceColumn" text="سعر الشراء" prefWidth="120"/>
                        <TableColumn fx:id="itemSalePriceColumn" text="سعر البيع" prefWidth="120"/>
                        <TableColumn fx:id="itemTotalColumn" text="المجموع" prefWidth="120"/>
                        <TableColumn fx:id="itemDeleteColumn" text="حذف" prefWidth="60"/>
                    </columns>
                </TableView>
                
                <HBox spacing="15" alignment="CENTER_RIGHT" style="-fx-padding: 5;">
                    <Label text="الإجمالي:" style="-fx-font-size: 16px; -fx-font-weight: bold; -fx-text-fill: #e8edf4;"/>
                    <Label fx:id="totalAmountLabel" text="0" style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: #34d399;"/>
                </HBox>
            </VBox>

        </VBox>
    </HBox>
    
    <!-- Action Buttons -->
    <HBox alignment="CENTER" spacing="15" style="-fx-padding: 10;">
        <CheckBox fx:id="printCheckbox" text="طباعة"/>
        <Button fx:id="saveBtn" text="حفظ" onAction="#handleSave"
                style="-fx-background-color: linear-gradient(to right, #f59e0b, #d97706); -fx-text-fill: white; -fx-font-size: 16px; -fx-font-weight: bold; -fx-padding: 12 40; -fx-background-radius: 8; -fx-cursor: hand;"/>
        <Button fx:id="newBtn" text="جديد" onAction="#handleNew"
                style="-fx-background-color: #3b82f6; -fx-text-fill: white; -fx-font-size: 16px; -fx-font-weight: bold; -fx-padding: 12 40; -fx-background-radius: 8; -fx-cursor: hand;"/>
        <Button text="إغلاق" onAction="#handleClose"
                style="-fx-background-color: #1a2744; -fx-text-fill: #e8edf4; -fx-font-size: 14px; -fx-font-weight: bold; -fx-padding: 12 30; -fx-background-radius: 8; -fx-cursor: hand; -fx-border-color: rgba(255,255,255,0.12); -fx-border-radius: 8;"/>
    </HBox>
    
</VBox>
